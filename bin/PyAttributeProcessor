#!/bin/sh

DS=$(basename $0)

## The instance argument can be used to override the server name
if [ $(echo $1 | grep "/" ) ] ; then
 IFS='/' read -r DS INSTANCE <<< "$1"
else
 DS=$(basename $0)
 INSTANCE=$1
fi

PKGNAME=$(echo '$DS' | tr '[:upper:]' '[:lower:]')
export PYTHONPATH=/usr/share/tangods-$PKGNAME:$PYTHONPATH

DSPATH=$(fandango find_module $DS)

# ## @TODO:all these database calls should be done in a single rc.py file
# # see fandango.scripts.DynamicDS to check all this stuff  
# DSPROPS=$(tango_property -e \
#           DSORB=ORBEndPoint.$DS/$INSTANCE \
#           LcPATH=Starter/$HOST.StartDSPath \
#           DfPATH=PYTHON_CLASSPATH.DeviceClasses \
#           PyPATH=PYTHON_CLASSPATH.$DS)
# 
# echo "Tango properties for $DS/$INSTANCE: $DSPROPS"
# for p in $DSPROPS; do 
# #   echo $p;
#   export $p;
# done
# 
# # DSORB=$(python -c "import PyTango;print(PyTango.Database().get_property(
# #   'ORBendPoint',['${DS}/${INSTANCE}']).values()[0][0])" 2>/dev/null)
# 
# # MUST
# if [ "$DSORB" ] ; then
#  DSORB="-ORBendPoint $DSORB"
# fi


#LAUNCHER=$(fandango get_class_property PyAttributeProcessor Launcher)
#LAUNCHER=$(fandango get_device_property dserver/PyAttributeProcessor/$1 Launcher)

#   HASSCREEN=$(which screen 2>/dev/null)
#   if [ ! "$( echo $1 | grep '\?' )" ] && [ "$HASSCREEN" ] ; then
#     if [ ! "$(echo $* | grep 'attach')" ] ; then
#       echo "run detached"
#       CMD="screen -dm -S $DS-$INSTANCE "
#     else
#       CMD="screen -S $DS-$INSTANCE "
#     fi
#   else
#     CMD=""
#   fi

CMD=""
CMD="${CMD} python ${DSPATH}/$DS.py $INSTANCE $2 $DSORB"
echo $CMD
$CMD



